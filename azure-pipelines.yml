# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
  branches:
    include:
      - master
  tags:
    include:
      - v*

variables:
  vmImageName: 'ubuntu-latest'



stages:
- stage: Build
  displayName: Build and push stage
  jobs:  
  - job: Build
    displayName: Build job
    pool:
      vmImage: $(vmImageName)
    steps:
    - task: Bash@3
      inputs:
        targetType: 'inline'
        script: 'make image'
    - task: Docker@2
      inputs:
        containerRegistry: 'dockerHub'
        command: 'login'
    - task: Bash@3
      inputs:
        targetType: 'inline'
        script: |
          docker tag acottais/portctl:0.1.0 acottais/portctl:latest
          docker push acottais/portctl:0.1.0
          docker push acottais/portctl:latest
- stage: Release
  displayName: Publish the release to Github
  condition: and(succeeded(),contains(variables['Build.SourceBranch'], 'tags'))
  jobs:
  - job: Publish
    displayName: Publish Job
      pool:
      vmImage: $(vmImageName)
    steps:
    - task: Bash@3
      inputs:
        targetType: 'inline'
        script: 'make binaries'
    - task: GitHubRelease@0
      inputs:
        gitHubConnection: acottais
        repositoryName: '$(Build.Repository.Name)' 
        action: 'create' # Options: create, edit, delete
        target: '$(Build.SourceVersion)' # Required when action == Create || Action == Edit
        tagSource: 'manual' # Required when action == Create# Options: auto, manual
        #tag: # Required when action == Edit || Action == Delete || TagSource == Manual
        #title: # Optional
        #releaseNotesSource: 'file' # Optional. Options: file, input
        #releaseNotesFile: # Optional
        #releaseNotes: # Optional
        #assets: '$(Build.ArtifactStagingDirectory)/*' # Optional
        #assetUploadMode: 'delete' # Optional. Options: delete, replace
        #isDraft: false # Optional
        #isPreRelease: false # Optional
        #addChangeLog: true # Optional 